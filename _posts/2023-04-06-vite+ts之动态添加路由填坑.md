---
layout:     post
title:     	基于router4版本的动态添加路由
subtitle: 	vite+ts搭建过程中踩坑之一
date:       2023-04-06
author:     疏影
header-img: img/home-bg-o.jpg
catalog: true
tags:
    - vite2
    - vue3
    - ts
    - 学习
    - vue-router
---

# 前言
>这个router4的动态添加路由折磨了我两天,哎说到底还是水平有限.

### glob路径匹配不上
vite的官方文档是写着:
“该 Glob 模式会被当成导入标识符：必须是相对路径（以 ./ 开头）或绝对路径（以 / 开头，相对于项目根目录解析）或一个别名路径（请看 resolve.alias 选项)。”
但我是使用了别名路径怎么都是undefined,网上也查不到有人使用别名路径,拉倒吧,最后还是妥协了使用绝对路径.
注意一点:vue文件在有几层,通配符“\*”就要写几层,比如我的是‘/src/views/ff14/raider/log/index.vue’,glob匹配规则就必须写‘/src/views/*/*/*.vue’.

### 寻找路由陷入死循环
在路由的前置守卫里动态添加路由时一定要设置变量节流,不然会进入进入守卫-添加路由-进入守卫-添加路由的死循环
![设置节流](/img/2023-04-06-router.png)

### 刷新空白或显示404
动态添加路由有个问题就是刷新时路由还没添加,会变成白屏,尤其是异步的情况下.
其实通过前面的方法已经可以避免刷新空白的问题,但是会引发新问题,控制台会报一个无此路由的警告.因为在你添加路由之前vue找不到你对应的路由,解决办法的思路就是添加一个通配的页面让每个path都有一个备选页面--404.
添加404有一个坑就是不可以写name,如果写name的话刷新会直接进入404,我猜是因为写了name刷新时这个path就变成固定路由了,即使后面添加了相同path的路由,router应该还是会取前者也就是404,所以不写name的话就可以避免这个问题
```
// ↓404
  {
    path: '/:catchAll(.*)',
    component: () => import('@/views/error/404.vue'),
  },
```